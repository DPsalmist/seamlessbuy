{% extends 'store/base.html' %}
{% load static %}

{% block title %}
{% if category %}{{ category.name }}{% else %}Cart{% endif %}
{% endblock %}

{% block content %}

<main class="main">
    <div class="page-header text-center" style="background-image: url('assets/images/page-header-bg.jpg')">
        <div class="container">
            <h1 class="page-title">Checkout<span>Shop</span></h1>
        </div><!-- End .container -->
    </div><!-- End .page-header -->
    <nav aria-label="breadcrumb" class="breadcrumb-nav">
        <div class="container">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'store:product_list' %}">Home</a></li>
                <li class="breadcrumb-item"><a href="{% url 'store:product_list' %}">Shop</a></li>
                <li class="breadcrumb-item active" aria-current="page">Checkout</li>
            </ol>
        </div><!-- End .container -->
    </nav><!-- End .breadcrumb-nav -->

    <div class="page-content">
        <div class="checkout">
            <div class="container">
                <div class="checkout-discount">
                    <form method="POST" action="#">
                        <input type="text" class="form-control" required id="checkout-discount-input">
                        <label for="checkout-discount-input" class="text-truncate">Have a coupon? <span>Click here to enter your code</span></label>
                    </form>
                </div><!-- End .checkout-discount -->
                <form action="{% url 'store:checkout' %}" method="POST" id="form">
                    <h2 class="checkout-title">Order Billing Details</h2><!-- End .checkout-title -->
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-lg-9" id="user-info">
                            
                                <div class="row">
                                    <div class="col-sm-6">
                                        <label>First Name *</label>
                                        <input name="fname" type="text" class="form-control" required>
                                    </div><!-- End .col-sm-6 -->

                                    <div class="col-sm-6">
                                        <label>Last Name *</label>
                                        <input name="lname" type="text" class="form-control" required>
                                    </div><!-- End .col-sm-6 -->
                                </div><!-- End .row -->

                                <label>Company Name (Optional)</label>
                                <input name="company" type="text" class="form-control">

                                <label>State *</label>
                                <input name="state" type="text" class="form-control" required>

                                <label>Street address *</label>
                                <input name="address" type="text" class="form-control" placeholder="House number and Street name" required />

                                <div class="row">
                                    <div class="col-sm-6">
                                        <label>Town / City *</label>
                                        <input name="city" type="text" class="form-control" required>
                                    </div><!-- End .col-sm-6 -->

                                    <div class="col-sm-6">
                                        <label>Postcode / Zip *</label>
                                        <input name="zip_code" type="text" class="form-control" required>
                                    </div><!-- End .col-sm-6 -->
                                </div><!-- End .row -->

                                <div class="row">
                                    <div class="col-sm-6">
                                        <label>Email address *</label>
                                        <input name="email" type="email" class="form-control" required>
                                    </div><!-- End .col-sm-6 -->

                                    <div class="col-sm-6">
                                        <label>Phone *</label>
                                        <input name="phone_no" type="tel" class="form-control" required>
                                    </div><!-- End .col-sm-6 -->
                                </div><!-- End .row -->

                                <div class="custom-control custom-checkbox">
                                    <input type="checkbox" name="create_account" value="true" class="custom-control-input" id="checkout-create-acc">
                                    <label class="custom-control-label" for="checkout-create-acc">Create an account?</label>
                                </div><!-- End .custom-checkbox -->

                                <label>Order notes (optional)</label>
                                <textarea class="form-control" name="notes" cols="30" rows="4" placeholder="Notes about your order, e.g. special notes for delivery"></textarea>
                                <br>
                                <input id="form-button" type="submit" value="Submit" class="btn btn-outline-primary-2 btn-order btn-block" >
                        </div>
                        <!-- End .col-lg-9 -->

                        {% comment %} Permanent Payment Info {% endcomment %}
                        <aside class="col-lg-3">
                            <div class="summary">
                                <h3 class="summary-title">Your Order</h3><!-- End .summary-title -->

                                <table class="table table-summary">
                                    <thead>
                                        <tr>
                                            <th>Product</th>
                                            <th>Total</th>
                                        </tr>
                                    </thead>

                                    <tbody>
                                        <tr>
                                            <td><a href="#">Beige knitted elastic runner shoes</a></td>
                                            <td>$84.00</td>
                                        </tr>

                                        <tr>
                                            <td><a href="#">Blue utility pinafore denimdress</a></td>
                                            <td>$76,00</td>
                                        </tr>
                                        <tr class="summary-subtotal">
                                            <td>Subtotal:</td>
                                            <td>$160.00</td>
                                        </tr><!-- End .summary-subtotal -->
                                        <tr>
                                            <td>Shipping:</td>
                                            <td>&#x20A6;2000 for orders within Lagos</td>
                                        </tr>
                                        <tr class="summary-total">
                                            <td>Total:</td>
                                            <td>&#x20A6;{{ order.get_cart_total }}</td>
                                        </tr><!-- End .summary-total -->
                                    </tbody>
                                </table><!-- End .table table-summary -->
                                <hr>
                                    </div><!-- End .card -->
                                </div><!-- End .accordion -->

                                {% comment %} <button id="form-button" type="submit" class="btn btn-outline-primary-2 btn-order btn-block">
                                    <span class="btn-text">Place Order</span>
                                    <span class="btn-hover-text">Proceed to Checkout</span>
                                </button> {% endcomment %}
                            </div><!-- End .summary -->
                        </aside><!-- End .col-lg-3 -->
                    </div><!-- End .row -->
                </form>

                    <br>
                    {% comment %} Payment Info Section {% endcomment %}
                    <div class="container">
                    <div class="col-lg-2"></div>
                    <div class="col-lg-8 hidden" id="payment-info">
                        <h2 class="checkout-title">Payment Details</h2><!-- End .checkout-title -->
                        <div class="summary">
                        <b>Select method of payment</b>
                            <hr>
                            <div class="accordion-summary">
                                <div class="card">
                                    <div class="card-header" id="heading-1">
                                        <h2 class="card-title">
                                            <a role="button" data-toggle="collapse" href="#collapse-1" aria-expanded="true" aria-controls="collapse-1">
                                                Direct bank transfer
                                            </a>
                                        </h2>
                                    </div><!-- End .card-header -->
                                    <div id="collapse-1" class="collapse show" aria-labelledby="heading-1" data-parent="#accordion-payment">
                                        <div class="card-body">
                                            Make your payment directly into our bank account. Please use your Order ID as the payment reference. 
                                            Your order will not be shipped until the funds have cleared in our account.
                                            <hr>
                                            <ul>
                                                <li>Acount Name: Sterling Crest Global Services </li>
                                                <li>Bank: UBA </li>
                                                <li>Account Number: 1022382633</li>
                                            </ul>
                                        </div><!-- End .card-body -->
                                    </div><!-- End .collapse -->
                                </div><!-- End .card -->
                                
                                <div class="card">
                                    <div class="card-header" id="heading-3">
                                        <h2 class="card-title">
                                            <a class="collapsed" role="button" data-toggle="collapse" href="#collapse-3" aria-expanded="false" aria-controls="collapse-3">
                                                Cash on delivery
                                            </a>
                                        </h2>
                                    </div><!-- End .card-header -->
                                    <div id="collapse-3" class="collapse" aria-labelledby="heading-3" data-parent="#accordion-payment">
                                        <div class="card-body">We also accept payment on delivery. You'll have to log in to your dashboard
                                            to track the status of ypur order. Once your order is delivered and cash payment is made, it's reflected on your dashboard.  
                                        </div><!-- End .card-body -->
                                    </div><!-- End .collapse -->
                                </div><!-- End .card -->

                                <div class="card">
                                    <div class="card-header" id="heading-4">
                                        <h2 class="card-title">
                                            <a class="collapsed" role="button" data-toggle="collapse" href="#collapse-4" aria-expanded="false" aria-controls="collapse-4">
                                                PayPal <small class="float-right paypal-link">What is PayPal?</small>
                                            </a>
                                        </h2>
                                    </div><!-- End .card-header -->
                                    <div id="collapse-4" class="collapse" aria-labelledby="heading-4" data-parent="#accordion-payment">
                                        <div class="card-body">
                                            PayPal is an electronic commerce company that facilitates payments between parties through
                                            online funds transfers. You can make your payment into our paypal account.
                                        </div><!-- End .card-body -->
                                    </div><!-- End .collapse -->
                                </div><!-- End .card -->

                                <div class="card">
                                    <div class="card-header" id="heading-5">
                                        <h2 class="card-title">
                                            <a class="collapsed" role="button" data-toggle="collapse" href="#collapse-5" aria-expanded="false" aria-controls="collapse-5">
                                                Credit Card (Stripe)
                                                <img src="{% static 'assets/images/payments-summary.png' %}" alt="payments cards">
                                            </a>
                                        </h2>
                                    </div><!-- End .card-header -->
                                    <div id="collapse-5" class="collapse" aria-labelledby="heading-5" data-parent="#accordion-payment">
                                        <div class="card-body"> Coming soon. We're working steadfastly on this mode of payment. 
                                        </div><!-- End .card-body -->
                                    </div><!-- End .collapse -->
                                </div><!-- End .card -->
                            </div><!-- End .accordion -->

                            <button id="payment-button" type="submit" class="btn btn-outline-primary-2 btn-order btn-block">
                                <span class="btn-text">Place Order</span>
                                <span class="btn-hover-text">Proceed to Checkout</span>
                            </button>
                            <hr>
                            <button id="payment-button" type="submit" class="btn btn-outline-primary-2 btn-order btn-block">
                                <span class="btn-text">Buy on Credit</span>
                                <span class="btn-hover-text">Login to proceed</span>
                            </button>
                        </div>
                    </div>
                    <div class="col-lg-2"></div>
                </div>
            </div><!-- End .container -->
        </div><!-- End .checkout -->
    </div><!-- End .page-content -->
</main><!-- End .main -->

<script type="text/javascript">
    var user = '{{request.user}}'
    var shipping = '{{ order.shipping }}'
    var total = "{{ order.get_cart_total|floatformat:2 }}"
    var form = document.getElementById('form')
    const formData = new FormData(document.querySelector('form'))

    var create_acct = document.getElementById('checkout-create-acc').value
    document.getElementById("payment-info").style.display = "none";

    // hide user form if user is logged in already and doesn't need shipping 
    if (user != 'AnonymousUser' && shipping == 'False'){
        document.getElementById('user-info').classList.add('hidden')
        // show online payment if logged in user wants to buy item that doesn't require shipping
        document.getElementById('payment-info').classList.remove('hidden')
    }
    // Form details
    form.addEventListener('submit', function(e){
        e.preventDefault()
        document.getElementById('form').innerHTML = ''
        document.getElementById('payment-info').style.display = "block";
        document.getElementById('payment-info').classList.remove('hidden')
        console.log('Checkout Form submitted...')
        console.log('Create account is', create_acct)
    })
    // Call user form when payment butoom is clicked
    document.getElementById('payment-button').addEventListener('click', function (e){
        submitFormData()
    })

    function submitFormData(){
        console.log('Payment button clicked!')
        
        var userFormData = {
            'fname':null,
            'lname': null,
            'city':null,
            'state':null,
            'email':null,
            'address':null,
            'phone_no':null,
            'zip_code':null,
            'company':null,
            'total':total
        }
            console.log('default data value:', userFormData)
        
            // Get form data
            if (user == 'AnonymousUser'){
                userFormData.fname = form.fname.value
                userFormData.lname = form.lname.value
                userFormData.city = form.city.value
                userFormData.state = form.state.value
                userFormData.email = form.email.value
                userFormData.address = form.address.value
                userFormData.phone_no = form.phone_no.value
                userFormData.company = form.company.value
                shippingInfo.zip_code = form.zip_code.value

            }
            var shippingInfo = {
                'address':null,
                'city':null,
                'state':null,
                'phone_no':null,
                'zip_code':null,
            }
            // Get shipping values if user isn't loggedin
            if (shipping != 'False'){
                shippingInfo.address = form.address.value
                shippingInfo.city = form.city.value
                shippingInfo.state = form.state.value
                shippingInfo.phone_no = form.phone_no.value
                shippingInfo.zip_code = form.zip_code.value
            }

        console.log('shippingInfo:', shippingInfo)
        console.log('user info:', userFormData)

         // Redirect after successful payment
        var url = '/process_order/'
        fetch (url, {
            method:'POST',
            headers:{
                'Content-Type':'application/json',
                'X-CSRFToken':csrftoken,
            },
            body:JSON.stringify({'form':userFormData, 'shipping':shippingInfo})
        })
        .then((response) => response.json())
        .then((data) => {
            console.log('Success', data)
            alert('Transaction completed!');
            window.location.href = "{% url 'store:product_list' %}"
        })
    }

</script>
{% endblock content %} 